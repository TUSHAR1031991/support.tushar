<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Ticket Reports</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      padding: 20px;
    }
    .container {
      max-width: 1200px;
      margin: auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    h2 {
      color: #333;
      border-bottom: 2px solid #28a745;
      padding-bottom: 10px;
      margin-bottom: 20px;
    }
    .report-controls {
      display: flex;
      justify-content: space-between;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 15px;
    }
    .search-filter {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .search-filter input, .search-filter select {
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    .actions {
      display: flex;
      gap: 10px;
    }
    button {
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      transition: background-color 0.3s;
    }
    button.download {
      background: #17a2b8;
      color: white;
    }
    button.download:hover {
      background: #138496;
    }
    button.email {
      background: #6f42c1;
      color: white;
    }
    button.email:hover {
      background: #5a32a3;
    }
    button.new-ticket {
      background: #28a745;
      color: white;
    }
    button.new-ticket:hover {
      background: #218838;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      font-size: 14px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 12px;
      text-align: left;
    }
    th {
      background-color: #28a745;
      color: white;
      position: sticky;
      top: 0;
    }
    tr:nth-child(even) {
      background-color: #f9f9f9;
    }
    tr:hover {
      background-color: #f1f1f1;
    }
    .status-message {
      margin: 15px 0;
      padding: 12px;
      border-radius: 4px;
      display: none;
    }
    .success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .pagination {
      display: flex;
      justify-content: center;
      margin-top: 20px;
      gap: 5px;
    }
    .pagination button {
      padding: 5px 10px;
      background: #6c757d;
      color: white;
    }
    .pagination button.active {
      background: #28a745;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Ticket Reports</h2>
    
    <div class="report-controls">
      <div class="search-filter">
        <input type="text" id="searchInput" placeholder="Search tickets...">
        <select id="filterPriority">
          <option value="">All Priorities</option>
          <option value="Low">Low</option>
          <option value="Medium">Medium</option>
          <option value="High">High</option>
          <option value="Critical">Critical</option>
        </select>
        <select id="filterStatus">
          <option value="">All Types</option>
          <option value="Bug">Bug</option>
          <option value="Feature">Feature Request</option>
          <option value="Enhancement">Enhancement</option>
        </select>
      </div>
      <div class="actions">
        <button class="new-ticket" onclick="window.location.href='sap.html'">New Ticket</button>
        <button class="download" onclick="downloadReport()">Download CSV</button>
        <button class="email" onclick="showEmailDialog()">Email Report</button>
      </div>
    </div>
    
    <div id="reportData">
      <!-- Tickets will be loaded here -->
      <table id="ticketsTable">
        <thead>
          <tr>
            <th>Ticket #</th>
            <th>Company</th>
            <th>Contact</th>
            <th>Email</th>
            <th>Priority</th>
            <th>Type</th>
            <th>Summary</th>
            <th>Created</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="ticketsBody">
          <!-- Data will be inserted here by JavaScript -->
        </tbody>
      </table>
    </div>
    
    <div class="pagination" id="pagination">
      <!-- Pagination will be inserted here by JavaScript -->
    </div>
    
    <div id="statusMessage" class="status-message"></div>
  </div>

  <!-- Email Dialog (hidden by default) -->
  <div id="emailDialog" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
    <div style="background: white; padding: 20px; border-radius: 8px; width: 400px;">
      <h3>Email Report</h3>
      <div style="margin-bottom: 15px;">
        <label style="display: block; margin-bottom: 5px;">Email Address</label>
        <input type="email" id="emailAddress" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
      </div>
      <div style="display: flex; gap: 10px; justify-content: flex-end;">
        <button onclick="document.getElementById('emailDialog').style.display = 'none'">Cancel</button>
        <button onclick="sendEmailReport()" style="background: #28a745; color: white;">Send</button>
      </div>
    </div>
  </div>

  <script>
    // Configuration
    const itemsPerPage = 10;
    let currentPage = 1;
    let allTickets = [];
    let filteredTickets = [];

    // Load tickets from localStorage
    function loadTickets() {
      allTickets = JSON.parse(localStorage.getItem('tickets') || [];
      applyFilters();
      renderTable();
      renderPagination();
    }

    // Apply search and filters
    function applyFilters() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      const priorityFilter = document.getElementById('filterPriority').value;
      const statusFilter = document.getElementById('filterStatus').value;
      
      filteredTickets = allTickets.filter(ticket => {
        const matchesSearch = 
          (ticket.ticketNumber && ticket.ticketNumber.toLowerCase().includes(searchTerm)) ||
          (ticket.company && ticket.company.toLowerCase().includes(searchTerm)) ||
          (ticket.fullname && ticket.fullname.toLowerCase().includes(searchTerm)) ||
          (ticket.email && ticket.email.toLowerCase().includes(searchTerm)) ||
          (ticket.summary && ticket.summary.toLowerCase().includes(searchTerm));
        
        const matchesPriority = !priorityFilter || (ticket.priority === priorityFilter);
        const matchesStatus = !statusFilter || (ticket.type === statusFilter);
        
        return matchesSearch && matchesPriority && matchesStatus;
      });
      
      currentPage = 1; // Reset to first page when filters change
    }

    // Render tickets table
    function renderTable() {
      const tbody = document.getElementById('ticketsBody');
      tbody.innerHTML = '';
      
      const startIdx = (currentPage - 1) * itemsPerPage;
      const endIdx = startIdx + itemsPerPage;
      const ticketsToShow = filteredTickets.slice(startIdx, endIdx);
      
      if (ticketsToShow.length === 0) {
        tbody.innerHTML = '<tr><td colspan="10" style="text-align: center;">No tickets found</td></tr>';
        return;
      }
      
      ticketsToShow.forEach(ticket => {
        const tr = document.createElement('tr');
        
        // Format date
        const createdDate = ticket.timestamp ? new Date(ticket.timestamp).toLocaleDateString() : '-';
        
        // Determine status (simple example - you can enhance this)
        let status = 'Open';
        if (ticket.completedMonth) status = 'Completed';
        else if (ticket.hoursFunc || ticket.hoursTech) status = 'In Progress';
        
        tr.innerHTML = `
          <td>${ticket.ticketNumber || '-'}</td>
          <td>${ticket.company || '-'}</td>
          <td>${ticket.fullname || '-'}</td>
          <td>${ticket.email || '-'}</td>
          <td>${ticket.priority || '-'}</td>
          <td>${ticket.type || '-'}</td>
          <td>${ticket.summary ? ticket.summary.substring(0, 50) + (ticket.summary.length > 50 ? '...' : '') : '-'}</td>
          <td>${createdDate}</td>
          <td>${status}</td>
          <td>
            <button onclick="viewTicket('${ticket.ticketNumber}')" style="padding: 5px 10px; background: #17a2b8; color: white;">View</button>
          </td>
        `;
        
        tbody.appendChild(tr);
      });
    }

    // Render pagination controls
    function renderPagination() {
      const paginationDiv = document.getElementById('pagination');
      paginationDiv.innerHTML = '';
      
      const totalPages = Math.ceil(filteredTickets.length / itemsPerPage);
      if (totalPages <= 1) return;
      
      // Previous button
      const prevButton = document.createElement('button');
      prevButton.textContent = '«';
      prevButton.disabled = currentPage === 1;
      prevButton.onclick = () => {
        if (currentPage > 1) {
          currentPage--;
          renderTable();
        }
      };
      paginationDiv.appendChild(prevButton);
      
      // Page buttons
      for (let i = 1; i <= totalPages; i++) {
        const pageButton = document.createElement('button');
        pageButton.textContent = i;
        pageButton.className = currentPage === i ? 'active' : '';
        pageButton.onclick = () => {
          currentPage = i;
          renderTable();
          renderPagination();
        };
        paginationDiv.appendChild(pageButton);
      }
      
      // Next button
      const nextButton = document.createElement('button');
      nextButton.textContent = '»';
      nextButton.disabled = currentPage === totalPages;
      nextButton.onclick = () => {
        if (currentPage < totalPages) {
          currentPage++;
          renderTable();
        }
      };
      paginationDiv.appendChild(nextButton);
    }

    // Download report as CSV
    function downloadReport() {
      if (filteredTickets.length === 0) {
        showStatus('No tickets to download', 'error');
        return;
      }

      // Prepare headers
      const headers = [
        'Ticket Number', 'Company', 'Contact', 'Email', 'Phone', 
        'Priority', 'Type', 'Summary', 'Created', 'Status',
        'Requested By', 'Requested Month', 'Completed Month'
      ];
      
      // Prepare data rows
      const rows = filteredTickets.map(ticket => {
        const createdDate = ticket.timestamp ? new Date(ticket.timestamp).toLocaleDateString() : '';
        let status = 'Open';
        if (ticket.completedMonth) status = 'Completed';
        else if (ticket.hoursFunc || ticket.hoursTech) status = 'In Progress';
        
        return [
          ticket.ticketNumber || '',
          ticket.company || '',
          ticket.fullname || '',
          ticket.email || '',
          ticket.phone || '',
          ticket.priority || '',
          ticket.type || '',
          ticket.summary || '',
          createdDate,
          status,
          ticket.requestedBy || '',
          ticket.requestedMonth || '',
          ticket.completedMonth || ''
        ];
      });

      // Create CSV content
      const csvContent = [
        headers.join(','),
        ...rows.map(row => row.map(field => `"${field.toString().replace(/"/g, '""')}"`).join(','))
      ].join('\n');

      // Trigger download
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `tickets_report_${new Date().toISOString().slice(0,10)}.csv`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // Show email dialog
    function showEmailDialog() {
      document.getElementById('emailDialog').style.display = 'flex';
    }

    // Send email report
    function sendEmailReport() {
      const email = document.getElementById('emailAddress').value.trim();
      const statusDiv = document.getElementById('statusMessage');
      
      if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
        showStatus('Please enter a valid email address', 'error');
        return;
      }
      
      // In a real implementation, you would send this to your server
      // For this example, we'll simulate it
      showStatus('Preparing email...', 'info');
      document.getElementById('emailDialog').style.display = 'none';
      
      setTimeout(() => {
        showStatus(`Report sent to ${email} successfully!`, 'success');
      }, 1500);
    }

    // View single ticket
    function viewTicket(ticketNumber) {
      window.location.href = `ticket-details.html?ticket=${encodeURIComponent(ticketNumber)}`;
    }

    // Show status message
    function showStatus(message, type) {
      const statusDiv = document.getElementById('statusMessage');
      statusDiv.style.display = 'block';
      statusDiv.className = `status-message ${type}`;
      statusDiv.textContent = message;
      
      // Auto-hide success messages after 5 seconds
      if (type === 'success') {
        setTimeout(() => {
          statusDiv.style.display = 'none';
        }, 5000);
      }
    }

    // Initialize filters
    document.getElementById('searchInput').addEventListener('input', () => {
      applyFilters();
      renderTable();
      renderPagination();
    });
    
    document.getElementById('filterPriority').addEventListener('change', () => {
      applyFilters();
      renderTable();
      renderPagination();
    });
    
    document.getElementById('filterStatus').addEventListener('change', () => {
      applyFilters();
      renderTable();
      renderPagination();
    });

    // Load tickets when page loads
    window.onload = loadTickets;
  </script>
</body>
</html>
